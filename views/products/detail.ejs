<%- include('../partials/_top') %>

<main class="container product-detail">
    <div class="product-gallery">
        <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="main-image">
    </div>

    <div class="product-info">
        <h1><%= product.name %></h1>
        <p class="price">$<%= product.price.toFixed(2) %></p>
        <div class="description">
            <h2>Description</h2>
            <p><%= product.description %></p>
        </div>
        <div class="stock-status">
            <% if (product.stock > 0) { %>
                <p>In Stock: <%= product.stock %> items </p>
            <% } else { %>
                <p class="text-danger">Out of Stock</p>
            <% } %>
        </div>

        <div class="add-to-cart-controls">
            <button class="quantity-btn minus">-</button>
            <input type="number" class="quantity-input" value="1" min="1" max="<%= product.stock %>">
            <button class="quantity-btn plus">+</button>
            <button class="add-to-cart-btn" data-product-id="<%= product._id %>">Add to Cart</button>
        </div>
    </div>
</main>

<script>
  // Quantity control
  const qtyInput = document.querySelector('.quantity-input');
  const plusBtn = document.querySelector('.quantity-btn.plus');
  const minusBtn = document.querySelector('.quantity-btn.minus');

  if (plusBtn && qtyInput) {
    plusBtn.addEventListener('click', function () {
      const max = parseInt(qtyInput.getAttribute('max'), 10);
      const current = parseInt(qtyInput.value, 10) || 1;
      if (current < max) {
        qtyInput.value = current + 1;
      }
    });
  }

  if (minusBtn && qtyInput) {
    minusBtn.addEventListener('click', function () {
      const current = parseInt(qtyInput.value, 10) || 1;
      if (current > 1) {
        qtyInput.value = current - 1;
      }
    });
  }

  // Helper: update cart preview dropdown in _top.ejs
  function updateCartPreview(newCart, newTotalPrice) {
    const itemsContainer = document.getElementById('cart-preview-items');
    const footerContainer = document.getElementById('cart-preview-footer');
    const totalSpan = document.getElementById('cart-preview-total');
    const emptyPlaceholder = document.getElementById('cart-preview-empty');

    if (!itemsContainer || !footerContainer || !totalSpan) {
      return;
    }

    itemsContainer.innerHTML = '';

    if (!Array.isArray(newCart) || newCart.length === 0) {
      if (emptyPlaceholder) {
        emptyPlaceholder.innerText = 'Your cart is empty.';
        emptyPlaceholder.style.display = 'block';
      } else {
        itemsContainer.innerHTML =
          '<div class="dropdown-item px-3 py-2" id="cart-preview-empty">Your cart is empty.</div>';
      }
      footerContainer.style.display = 'none';
      return;
    }

    newCart.forEach((item) => {
      const imageUrl = item.imageUrl || '/images/placeholder.png';
      const price = Number(item.price || 0).toFixed(2);
      const qty = item.quantity || 0;

      const row = `
        <div class="dropdown-item d-flex align-items-center px-3 py-2">
          <img src="${imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border-radius: 10px;">
          <div class="flex-grow-1">
            <div class="small fw-semibold text-white">${item.name}</div>
            <div class="small text-muted">${qty} x $${price}</div>
          </div>
        </div>
      `;
      itemsContainer.insertAdjacentHTML('beforeend', row);
    });

    totalSpan.innerText = newTotalPrice;
    footerContainer.style.display = 'block';
    if (emptyPlaceholder) {
      emptyPlaceholder.style.display = 'none';
    }
  }

  // Add to Cart using RESTful service: POST /cart/items
  const addToCartBtn = document.querySelector('.add-to-cart-btn');
  if (addToCartBtn && qtyInput) {
    addToCartBtn.addEventListener('click', async function () {
      const productId = this.getAttribute('data-product-id');
      const quantity = parseInt(qtyInput.value, 10) || 1;
      const productName = document.querySelector('.product-info h1').innerText;

      if (!confirm(`Add ${quantity} x ${productName} to your cart?`)) {
        return;
      }

      try {
        const response = await fetch('/cart/items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ productId, quantity }),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert('Product added to cart!');

          // Update cart badge
          const cartBadge = document.getElementById('cart-badge');
          if (cartBadge) {
            cartBadge.innerText = result.totalCartItems;
            cartBadge.style.display = result.totalCartItems > 0 ? 'block' : 'none';
          }

          // Update preview dropdown
          updateCartPreview(result.newCart, result.newTotalPrice);
        } else {
          alert(result.message || 'Failed to add product to cart');
        }
      } catch (err) {
        console.error(err);
        alert('Failed to add product to cart');
      }
    });
  }
</script>

<%- include('../partials/_bottom') %>

