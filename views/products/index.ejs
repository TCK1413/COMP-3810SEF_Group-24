<%- include('../partials/_top') %>

<head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/product.css">
</head>


<main class="container">
    <h1>Products</h1>
    
    <div class="products-grid">
        <% products.forEach(product => { %>
            <div class="product-card">
                <a href="/products/<%= product._id %>">
                    <img 
                      src="<%= (product.imageUrl) ? product.imageUrl : '/images/placeholder.png' %>" 
                      alt="<%= product.name %>" 
                      class="product-image"
                    >
                    <span class="product-gender 
                        <%= product.gender === 'male' ? 'gender-male' : 
                           product.gender === 'female' ? 'gender-female' : 'gender-unisex' %>">
                        <%= product.gender === 'male' ? 'Men' : 
                           product.gender === 'female' ? 'Women' : 'Unisex' %>
                    </span>
                    <h3 class="product-name"><%= product.name %></h3>
                </a>
                <p class="product-price">$<%= product.price.toFixed(2) %></p>
                 
                <div class="add-to-cart-controls">
                    <button class="quantity-btn minus" data-product-id="<%= product._id %>">-</button>
                    <input 
                      type="number" 
                      class="quantity-input" 
                      data-product-id="<%= product._id %>" 
                      value="1" 
                      min="1" 
                      max="<%= product.stock %>">
                    <button class="quantity-btn plus" data-product-id="<%= product._id %>">+</button>
                    <button class="add-to-cart-btn" data-product-id="<%= product._id %>">Add to Cart</button>
                </div>
            </div>
        <% }) %>
    </div>
</main>

<script>
  // Quantity + / - controls
  document.querySelectorAll('.quantity-btn.plus').forEach((btn) => {
    btn.addEventListener('click', function () {
      const productId = this.getAttribute('data-product-id');
      const input = document.querySelector(
        `.quantity-input[data-product-id="${productId}"]`
      );
      if (!input) return;
      const max = parseInt(input.getAttribute('max'), 10);
      const current = parseInt(input.value, 10) || 1;
      if (current < max) {
        input.value = current + 1;
      }
    });
  });

  document.querySelectorAll('.quantity-btn.minus').forEach((btn) => {
    btn.addEventListener('click', function () {
      const productId = this.getAttribute('data-product-id');
      const input = document.querySelector(
        `.quantity-input[data-product-id="${productId}"]`
      );
      if (!input) return;
      const current = parseInt(input.value, 10) || 1;
      if (current > 1) {
        input.value = current - 1;
      }
    });
  });

  // Helper: update cart preview dropdown in _top.ejs
  function updateCartPreview(newCart, newTotalPrice) {
    const itemsContainer = document.getElementById('cart-preview-items');
    const footerContainer = document.getElementById('cart-preview-footer');
    const totalSpan = document.getElementById('cart-preview-total');
    const emptyPlaceholder = document.getElementById('cart-preview-empty');

    if (!itemsContainer || !footerContainer || !totalSpan) {
      return;
    }

    itemsContainer.innerHTML = '';

    if (!Array.isArray(newCart) || newCart.length === 0) {
      if (emptyPlaceholder) {
        emptyPlaceholder.innerText = 'Your cart is empty.';
        emptyPlaceholder.style.display = 'block';
      } else {
        itemsContainer.innerHTML =
          '<div class="dropdown-item px-3 py-2" id="cart-preview-empty">Your cart is empty.</div>';
      }
      footerContainer.style.display = 'none';
      return;
    }

    newCart.forEach((item) => {
      const imageUrl = item.imageUrl || '/images/placeholder.png';
      const price = Number(item.price || 0).toFixed(2);
      const qty = item.quantity || 0;

      const row = `
        <div class="dropdown-item d-flex align-items-center px-3 py-2">
          <img src="${imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border-radius: 10px;">
          <div class="flex-grow-1">
            <div class="small fw-semibold text-white">${item.name}</div>
            <div class="small text-muted">${qty} x $${price}</div>
          </div>
        </div>
      `;
      itemsContainer.insertAdjacentHTML('beforeend', row);
    });

    totalSpan.innerText = newTotalPrice;
    footerContainer.style.display = 'block';
    if (emptyPlaceholder) {
      emptyPlaceholder.style.display = 'none';
    }
  }

  // Add to Cart using RESTful service: POST /cart/items
  document.querySelectorAll('.add-to-cart-btn').forEach((btn) => {
    btn.addEventListener('click', async function () {
      const productId = this.getAttribute('data-product-id');
      const input = document.querySelector(
        `.quantity-input[data-product-id="${productId}"]`
      );
      const quantity = input ? parseInt(input.value, 10) || 1 : 1;
      const productName =
        this.closest('.product-card').querySelector('.product-name').innerText;

      if (!confirm(`Add ${quantity} x ${productName} to your cart?`)) {
        return;
      }

      try {
        const response = await fetch('/cart/items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ productId, quantity }),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert('Product added to cart!');

          // Update cart badge
          const cartBadge = document.getElementById('cart-badge');
          if (cartBadge) {
            cartBadge.innerText = result.totalCartItems;
            cartBadge.style.display = result.totalCartItems > 0 ? 'block' : 'none';
          }

          // Update preview dropdown
          updateCartPreview(result.newCart, result.newTotalPrice);
        } else {
          alert(result.message || 'Failed to add product to cart');
        }
      } catch (err) {
        console.error(err);
        alert('Failed to add product to cart');
      }
    });
  });
</script>

<%- include('../partials/_bottom') %>

