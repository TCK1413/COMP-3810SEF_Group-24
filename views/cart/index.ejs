<%- include('../partials/_top') %>

<head>
    <style>
      .cart-item-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 4px;
      }
      .cart-total-summary {
        border-top: 2px solid #333;
        padding-top: 15px;
        font-size: 1.25rem;
      }
      .empty-cart {
        text-align: center;
        padding: 40px 0;
        color: #777;
      }
    </style>
</head>

<main class="container my-4">
  <div class="row">
    <div class="col-lg-8">
      <h1>Your Cart</h1>
      <hr>

      <% if (!cart || cart.length === 0) { %>
        <div class="empty-cart">
          <h3>Your cart is empty</h3>
          <p>Browse our products and add something to your cart.</p>
          <a href="/products" class="btn btn-dark">Go to Products</a>
        </div>
      <% } else { %>
        <div class="list-group list-group-flush">
          
          <% cart.forEach(item => { %>
            <div class="list-group-item d-flex align-items-center">
              
              <img src="<%= item.imageUrl ? item.imageUrl : '/images/placeholder.png' %>" alt="<%= item.name %>" class="cart-item-img">
              
              <div class="flex-grow-1">
                <strong><%= item.name %></strong>
                <div class="text-muted">$<%= item.price.toFixed(2) %> each</div>
              </div>

              <div class="d-flex align-items-center">
                <label for="qty-<%= item.productId %>" class="form-label me-2 mb-0">Qty:</label>
                <input
                  type="number"
                  class="form-control cart-qty-input"
                  data-product-id="<%= item.productId %>"
                  id="qty-<%= item.productId %>"
                  value="<%= item.quantity %>"
                  min="1"
                  style="width: 70px;"
                >
                <button
                  type="button"
                  class="btn btn-dark btn-sm ms-2 cart-update-btn"
                  data-product-id="<%= item.productId %>"
                >
                  Update
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm ms-3 cart-remove-btn"
                  data-product-id="<%= item.productId %>"
                >
                  X
                </button>
              </div>

            </div>
          <% }) %>

        </div>
      <% } %>
    </div>

    <div class="col-lg-4">
      <div class="card bg-light p-3">
        <h4>Order Summary</h4>
        <hr>
        <div class="d-flex justify-content-between">
          <span>Subtotal (<%= locals.initialCartCount || 0 %> items)</span>
          <strong>$<%= locals.initialTotalPrice || '0.00' %></strong>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <span>Shipping</span>
          <strong>FREE</strong>
        </div>
        <hr>
        <div class="d-flex justify-content-between cart-total-summary">
          <strong>Total</strong>
          <strong>$<%= locals.initialTotalPrice || '0.00' %></strong>
        </div>
        <div class="d-grid mt-3">
          <a href="/checkout" class="btn btn-dark btn-lg">Proceed to Checkout</a>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  async function callCartApi(method, productId, body) {
    const options = { method, headers: {} };
    if (body) {
      options.headers['Content-Type'] = 'application/json';
      options.body = JSON.stringify(body);
    }
    const response = await fetch(`/cart/items/${productId}`, options);
    if (!response.ok) {
      let errorMessage = `Request failed with status ${response.status}`;
      try {
        const data = await response.json();
        if (data && data.message) {
          errorMessage = data.message;
        }
      } catch (e) {
        // ignore JSON parse errors
      }
      throw new Error(errorMessage);
    }
    return response.json();
  }

  document.querySelectorAll('.cart-update-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const productId = btn.getAttribute('data-product-id');
      const input = document.querySelector(
        `.cart-qty-input[data-product-id="${productId}"]`
      );
      const quantity = parseInt(input.value, 10);

      if (!Number.isInteger(quantity) || quantity <= 0) {
        alert('Quantity must be at least 1.');
        return;
      }

      try {
        await callCartApi('PATCH', productId, { quantity });
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to update cart item');
      }
    });
  });

  document.querySelectorAll('.cart-remove-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const productId = btn.getAttribute('data-product-id');
      if (!confirm('Remove this item from your cart?')) {
        return;
      }
      try {
        await callCartApi('DELETE', productId);
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to remove cart item');
      }
    });
  });
</script>

<%- include('../partials/_bottom') %>

