<%- include('../partials/_top', { title: 'Checkout' }) %>

<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-8">
      <h2 class="h4 mb-4">Shipping & Payment</h2>

      <!-- Email -->
      <div class="mb-3">
        <label class="form-label" for="email">Email</label>
        <input class="form-control" id="email" name="email" type="email"
               value="<%= userEmail || '' %>" placeholder="you@example.com" required>
      </div>

      <!-- Address -->
      <div class="mb-3">
        <label class="form-label">Shipping Address</label>

        <% if (!isGuest) { %>
          <!-- Only logged-in users see saved addresses -->
          <div class="mb-2">
            <label class="form-label small mb-1" for="addressSelect">Select Saved Address</label>
            <select id="addressSelect" class="form-select">
              <option value="">-- Enter a new address --</option>
              <% if (userAddresses && userAddresses.length) { %>
                <% userAddresses.forEach(function(a){ %>
                  <option value="<%= a._id %>" <%= a.isDefault ? 'selected' : '' %>>
                    <%= a.street %>, <%= a.city %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="setDefaultAddress">
            <label class="form-check-label" for="setDefaultAddress">Set as default address</label>
          </div>
        <% } %>

        <!-- New address form -->
        <div id="newAddressForm" class="<%= (!isGuest && userAddresses && userAddresses.length) ? 'd-none' : '' %>">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label" for="street">Street Address</label>
              <input type="text" class="form-control" id="street" required>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="city">City</label>
              <input type="text" class="form-control" id="city" required>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="postalCode">Postal Code</label>
              <input type="text" class="form-control" id="postalCode" required>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="country">Country</label>
              <select id="country" class="form-select" required>
                <option value="">Please select a country</option>
                <% if (countries && countries.length) { %>
                  <% countries.forEach(function(cn){ %>
                    <option value="<%= cn %>"><%= cn %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="phone">Phone (Optional)</label>
              <input type="tel" class="form-control" id="phone">
            </div>
          </div>

          <% if (!isGuest) { %>
            <div class="mt-3">
              <button id="saveAddressBtn" class="btn btn-outline-secondary btn-sm">
                Save this address
              </button>
            </div>
          <% } %>
        </div>
      </div>

      <hr class="my-4">

      <!-- Payment button -->
      <div class="d-grid">
        <button id="checkoutBtn" class="btn btn-dark btn-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               fill="currentColor" class="me-2" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v1H0V4z"/>
            <path d="M0 7h16v5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V7zm3 3a1 1 0 1 0 0 2h3a1 1 0 1 0 0-2H3z"/>
          </svg>
          Continue to Payment
        </button>
      </div>

      <p class="text-muted small mt-3">
        You will be redirected to Stripe to complete your payment using their secure checkout.
        <br>Test card: <code>4242&nbsp;4242&nbsp;4242&nbsp;4242</code>
      </p>
    </div>

    <!-- Cart summary -->
    <div class="col-lg-4">
      <h3 class="h5">Your Cart</h3>
      <% if (cart.items && cart.items.length) { %>
        <div class="card">
          <div class="list-group list-group-flush">
            <% cart.items.forEach(function(item){ %>
              <div class="list-group-item d-flex align-items-center">
                <img src="<%= item.imageUrl || '/images/placeholder.png' %>" class="rounded me-3"
                     style="width:48px;height:48px;object-fit:cover">
                <div class="flex-grow-1">
                  <div class="fw-semibold"><%= item.name %></div>
                  <div class="small text-muted">Qty: <%= item.quantity %></div>
                </div>
                <div class="fw-semibold">$<%= Number(item.price).toFixed(2) %></div>
              </div>
            <% }) %>
          </div>
          <div class="card-body d-flex justify-content-between">
            <span class="text-muted">Total (USD)</span>
            <span class="fw-semibold">$<%= Number(totalPrice || 0).toFixed(2) %></span>
          </div>
        </div>
      <% } else { %>
        <div class="alert alert-info mt-2">Your cart is empty.</div>
      <% } %>
    </div>
  </div>
</div>

<script>
const IS_GUEST = <%= isGuest ? 'true' : 'false' %>;

function isDigits(val){ return /^[0-9]+$/.test(val); }
function showNewForm(show){ const nf = document.getElementById('newAddressForm'); if (nf) nf.classList.toggle('d-none', !show); }

(function init(){
  if (IS_GUEST) {
    showNewForm(true);
  } else {
    const sel = document.getElementById('addressSelect');
    showNewForm(sel ? sel.value === '' : true);
  }
})();

if (!IS_GUEST) {
  const sel = document.getElementById('addressSelect');
  if (sel) {
    sel.addEventListener('change', e => showNewForm(e.target.value === ''));
  }

  const saveBtn = document.getElementById('saveAddressBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();

      const street = document.getElementById('street').value.trim();
      const city   = document.getElementById('city').value.trim();
      const postal = document.getElementById('postalCode').value.trim();
      const country= document.getElementById('country').value;
      const phone  = document.getElementById('phone').value.trim();
      const setDef = document.getElementById('setDefaultAddress')?.checked || false;

      if (!street || !city || !postal || !country) return alert('Please complete the address form.');
      if (!isDigits(postal)) return alert('Postal Code must be digits only.');
      if (phone && !isDigits(phone)) return alert('Phone must be digits only.');

      try {
        const resp = await fetch('/checkout/save-address', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ street, city, postalCode: postal, country, phone, setDefault: setDef }),
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || 'Failed to save address');

        const select = document.getElementById('addressSelect');
        const opt = document.createElement('option');
        opt.value = data.address._id;
        opt.textContent = data.address.label;
        select.appendChild(opt);
        select.value = data.address._id;
        showNewForm(false);
        alert('Address saved.');
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to save address.');
      }
    });
  }
}

document.getElementById('checkoutBtn').addEventListener('click', async () => {
  const emailEl = document.getElementById('email');
  const email   = emailEl ? emailEl.value.trim() : '';

  if (!email) {
    alert('Please enter your email address.');
    if (emailEl) emailEl.focus();
    return;
  }

  let payload = { email };

  if (IS_GUEST) {
    const street = document.getElementById('street').value.trim();
    const city   = document.getElementById('city').value.trim();
    const postal = document.getElementById('postalCode').value.trim();
    const country= document.getElementById('country').value;
    const phone  = document.getElementById('phone').value.trim();

    if (!street || !city || !postal || !country) return alert('Please complete the address form.');
    if (!isDigits(postal)) return alert('Postal Code must be digits only.');
    if (phone && !isDigits(phone)) return alert('Phone must be digits only.');

    payload.useSavedAddress = false;
    payload.address = { street, city, postalCode: postal, country, phone };
  } else {
    const sel = document.getElementById('addressSelect');
    const setDef = document.getElementById('setDefaultAddress')?.checked || false;

    if (sel && sel.value) {
      payload.useSavedAddress = true;
      payload.addressId = sel.value;
      payload.setDefaultAddress = !!setDef;
    } else {
      const street = document.getElementById('street').value.trim();
      const city   = document.getElementById('city').value.trim();
      const postal = document.getElementById('postalCode').value.trim();
      const country= document.getElementById('country').value;
      const phone  = document.getElementById('phone').value.trim();

      if (!street || !city || !postal || !country) return alert('Please complete the address form.');
      if (!isDigits(postal)) return alert('Postal Code must be digits only.');
      if (phone && !isDigits(phone)) return alert('Phone must be digits only.');

      payload.useSavedAddress = false;
      payload.address = { street, city, postalCode: postal, country, phone };
      payload.setDefaultAddress = !!setDef;
    }
  }

  try {
    const resp = await fetch('/checkout/create-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await resp.json();
    if (!resp.ok || !data.url) {
      const msg = data.error || 'Failed to create checkout session.';
      alert(msg);
      return;
    }
    window.location.href = data.url;
  } catch (err) {
    console.error(err);
    alert(err.message || 'Unable to proceed to payment.');
  }
});
</script>

<%- include('../partials/_bottom') %>

