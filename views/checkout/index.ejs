<%- include('../partials/_top') %>

<head>
    <title><%= title %></title>
    <style>
      .checkout-summary {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 20px;
      }
      .summary-item-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
      }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
</head>

<main class="container my-4">
  <div class="row g-5">
    
    <div class="col-md-5 col-lg-4 order-md-last">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-dark">Your Cart</span>
        <span class="badge bg-dark rounded-pill"><%= locals.initialCartCount %></span>
      </h4>
      <ul class="list-group mb-3 checkout-summary">
        <% cart.forEach(item => { %>
          <li class="list-group-item d-flex justify-content-between lh-sm">
            <img src="<%= item.imageUrl ? item.imageUrl : '/images/placeholder.png' %>" alt="<%= item.name %>" class="summary-item-img me-2">
            <div>
              <h6 class="my-0"><%= item.name %></h6>
              <small class="text-body-secondary">Qty: <%= item.quantity %></small>
            </div>
            <span class="text-body-secondary">$<%= (item.price * item.quantity).toFixed(2) %></span>
          </li>
        <% }) %>
        
        <li class="list-group-item d-flex justify-content-between">
          <span>Total (USD)</span>
          <strong>$<%= locals.initialTotalPrice %></strong>
        </li>
      </ul>
    </div>

    <div class="col-md-7 col-lg-8">
      <h4 class="mb-3">Shipping & Payment</h4>
      
      <form action="/checkout/create-session" method="POST">
        
        <div class="row g-3">
          
          <div class="col-12">
            <label for="email" class="form-label">Email</label>
            <% if (session.authenticated && userEmail) { %>
              <input type="email" class="form-control" id="email" name="customerEmail" value="<%= userEmail %>" readonly>
            <% } else { %>
              <input type="email" class="form-control" id="email" name="customerEmail" placeholder="you@example.com" required>
            <% } %>
          </div>

          <hr class="my-4">
          <h5 class="mb-3">Shipping Address</h5>

          <% if (session.authenticated && userAddresses && userAddresses.length > 0) { %>
            <div class="col-12">
              <label for="selectedAddress" class="form-label">Select Saved Address</label>
              <select class="form-select" id="selectedAddress" name="selectedAddress">
                <option value="new">-- Enter a new address --</option>
                <% userAddresses.forEach(addr => { %>
                  <option value="<%= addr._id %>" <%= addr.isDefault ? 'selected' : '' %>>
                    <%= addr.street %>, <%= addr.city %>
                  </option>
                <% }) %>
              </select>
            </div>
            <hr class="my-4">
          <% } %>

          <div id="new-address-form">
            <div class="row g-3">
              <div class="col-12">
                <label for="street" class="form-label">Street Address</label>
                <input type="text" class="form-control" id="street" name="street" required>
              </div>
              <div class="col-md-4">
                <label for="city" class="form-label">City</label>
                <input type="text" class="form-control" id="city" name="city" required>
              </div>
              <div class="col-md-4">
                <label for="postalCode" class="form-label">Postal Code</label>
                <input type="text" class="form-control" id="postalCode" name="postalCode" required inputmode="numeric" pattern="[0-9]+" title="  Enter numbers only">
              </div>
              <div class="col-md-4">
	  	<label for="country" class="form-label">Country</label>
	  	<select name="country" id="country" class="form-select" required>
	    	<option value="">Please select a country...</option>
	    	<% if (typeof countries !== 'undefined' && countries && countries.length) { %>
	      	<% countries.forEach(function(countryName){ %>
			<option 
		  	value="<%= countryName %>"
		  	<%= (typeof address !== 'undefined' && address && address.country === countryName) 
		        	|| (typeof formData !== 'undefined' && formData.country === countryName) 
		        	? 'selected' : '' %>>
		  	<%= countryName %>
			</option>
	      	<% }) %>
	    	<% } %>
	  	</select>
	  </div>

              <div class="col-md-6">
                <label for="phone" class="form-label">Phone <span class="text-body-secondary">(Optional)</span></label>
                <input type="tel" class="form-control" id="phone" name="phone" inputmode="numeric" pattern="[0-9]+" title="  Enter numbers only">
              </div>
            </div>
          </div>
        </div>

        <hr class="my-4">

        <h5 class="mb-3">Payment</h5>
        <p>You will be redirected to Stripe to complete your payment using their secure checkout.</p>
        <p class="text-muted">You can use the test card number: 4242 4242 4242 4242</p>

        <button class="w-100 btn btn-dark btn-lg" type="submit">
          Continue to Payment
        </button>
      </form>
    </div>
  </div>
</main>

<script>
  const addressSelect = document.getElementById('selectedAddress');
  const newAddressForm = document.getElementById('new-address-form');
  
  if (addressSelect) {
    // 函數：根據下拉菜單切換表單
    function toggleAddressForm() {
      if (addressSelect.value === 'new') {
        newAddressForm.style.display = 'block';
        // 設為 required
        newAddressForm.querySelectorAll('input, select').forEach(el => el.required = true);
      } else {
        newAddressForm.style.display = 'none';
        // 取消 required
        newAddressForm.querySelectorAll('input, select').forEach(el => el.required = false);
      }
    }
    
    // 監聽變化
    addressSelect.addEventListener('change', toggleAddressForm);
    // 頁面加載時執行一次
    toggleAddressForm();
  }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const postalInput = document.getElementById('postalCode');
  const phoneInput = document.getElementById('phone');

  form.addEventListener('submit', function(e) {
    const postal = postalInput.value.trim();
    const phone = phoneInput.value.trim();

    // 只要包含非数字就报错
    const nonDigit = /\D/;

    if (postal && nonDigit.test(postal)) {
      e.preventDefault();
      alert('Postal Code must contain numbers only.');
      postalInput.focus();
      return false;
    }

    if (phone && nonDigit.test(phone)) {
      e.preventDefault();
      alert('Phone must contain numbers only.');
      phoneInput.focus();
      return false;
    }
  });
});
</script>

<%- include('../partials/_bottom') %>
